version: 2.1
orbs:
  rn: react-native-community/react-native@7.1.1
commands:
  write-app-env-vars:
    description: "Write environment variables to .env.* file"
    parameters:
      envtype:
        type: string
      API_URL:
        type: env_var_name
      ENV:
        type: env_var_name
    steps:
      - run:
          name: Write environment variables to .env.* file
          command: |
            echo "API_URL=${<< parameters.API_URL >>}" >> .env.<< parameters.envtype >>
            echo "ENV=${<< parameters.ENV >>}" >> .env.<< parameters.envtype >>
  write-android-signing-keys:
    description: "Write Android signing keys to gradle.properties"
    steps:
      - run:
          name: Write Android signing keys to gradle.properties
          command: |
            mkdir ~/.gradle
            touch ~/.gradle/gradle.properties
            echo "CIRCLECI_RN_TEST_UPLOAD_STORE_FILE=${CIRCLECI_RN_TEST_UPLOAD_STORE_FILE}" >> ~/.gradle/gradle.properties
            echo "CIRCLECI_RN_TEST_UPLOAD_STORE_PASSWORD=${CIRCLECI_RN_TEST_UPLOAD_STORE_PASSWORD}" >> ~/.gradle/gradle.properties
            echo "CIRCLECI_RN_TEST_UPLOAD_KEY_ALIAS=${CIRCLECI_RN_TEST_UPLOAD_KEY_ALIAS}" >> ~/.gradle/gradle.properties
            echo "CIRCLECI_RN_TEST_UPLOAD_KEY_PASSWORD=${CIRCLECI_RN_TEST_UPLOAD_KEY_PASSWORD}" >> ~/.gradle/gradle.properties
  write-android-keystore:
    description: "Write Android Keystore"
    steps:
      - run:
          name: Write Android Keystore
          command: echo $ANDROID_ENCRYPTED_KEYSTORE | base64 --decode > ./android/app/android.keystore
  write-google-play-credentials:
    description: "Write Google Play Upload Key Credentials"
    steps:
      - run:
          name: Write Google Play Upload Key Credentials
          command: echo $GOOGLE_PLAY_SERVICE_KEY | base64 --decode > /tmp/google-play-credentials.json
  show-diff:
    description: "Show git diff"
    steps:
      - run:
          name: Show git diff
          command: git --no-pager diff -p
  set-git-user-information:
    description: "Set Git user information"
    steps:
      - run:
          name: Set Git user information
          command: |
            git config --global user.name "CircleCI Server"
            git config --global user.email "noreply@circleci.com"
jobs:
  test:
    docker:
      - image: cimg/android:2023.07-node
    environment:
      FL_OUTPUT_DIR: output
      GEM_HOME: "${HOME}/.gem"
    steps:
      - checkout
      - set-git-user-information
      - run: 
          name: Set Ruby Path
          command: |
            echo 'export PATH="$HOME/.gem/bin:$PATH"' >> $BASH_ENV
      - run:
          name: Install RVM and Ruby
          command: |
            sudo apt-get update
            sudo apt-get install -y libssl-dev
            gpg --keyserver hkp://keyserver.ubuntu.com --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB
            curl -sSL https://get.rvm.io | bash -s stable
            source /home/circleci/.rvm/scripts/rvm
            echo 'source /home/circleci/.rvm/scripts/rvm' >> $BASH_ENV
            rvm requirements
            rvm remove 3.0.6
            rvm pkg install openssl
            rvm install 3.0.6 --with-openssl-dir=$HOME/.rvm/usr
            rvm use 3.0.6 --default
            ruby -v # To verify the installation
      - rn/yarn_install
      - run:
          name: Run Jest Tests
          command: yarn test
      - run:
          name: Install React Native Gem Bundler
          command: gem install bundler
      - run:
          name: Bundle Install React Native
          command: rvm use 3.0.6 do bundle install
      - run:
          name: Install specific CocoaPods version
          command: bundle exec pod install
          working_directory: ios
      - run:
          name: Install fastlane
          command: bundle install
          working_directory: fastlane
      - write-app-env-vars:
          envtype: staging
          API_URL: API_URL_STAGING
          ENV: ENV_STAGING
      - write-android-signing-keys
      - write-android-keystore
      - write-google-play-credentials
      - add_ssh_keys:
          fingerprints:
            - "eb:e1:59:78:03:cc:f6:6a:e4:bf:d4:63:13:f7:e5:78"
      - show-diff
      - run:
          name: Bump Build
          command: yarn bump-build-and-skip-ci
      - run:
          name: Push Build Commit
          command: git push
      - run:
          name: Deploy with fastlane
          command: bundle exec fastlane android internal_beta
          working_directory: fastlane
      - store_artifacts:
          path: output
workflows:
  test:
    jobs:
      - test